#include "convert.h"
#include <stdio.h>
#include <stdint.h>
#include <stddef.h>
#include <string.h>




static const utf8_char cp1251_table[128] = {
	{2, {0xd0, 0x82}}, 				{2, {0xd0, 0x83}},
	{3, {0xe2, 0x80, 0x9a}},		{2, {0xd1, 0x93}},
	{3, {0xe2, 0x80, 0x9e}}, 		{3, {0xe2, 0x80, 0xa6}},
	{3, {0xe2, 0x80, 0xa0}},		{3, {0xe2, 0x80, 0xa1}},
	{3, {0xe2, 0x82, 0xac}}, 		{3, {0xe2, 0x80, 0xb0}},
	{2, {0xd0, 0x89}},				{3, {0xe2, 0x80, 0xb9}},
	{2, {0xd0, 0x8a}},				{2, {0xd0, 0x8c}},
	{2, {0xd0, 0x8b}},				{2, {0xd0, 0x8f}},

	{2, {0xd1, 0x92}},				{3, {0xe2, 0x80, 0x98}},
	{3, {0xe2, 0x80, 0x99}},		{3, {0xe2, 0x80, 0x9c}},
	{3, {0xe2, 0x80, 0x9d}},		{3, {0xe2, 0x80, 0xa2}},
	{3, {0xe2, 0x80, 0x93}},		{3, {0xe2, 0x80, 0x94}},
	{0, {0}},						{3, {0xe2, 0x84, 0xa2}},
	{2, {0xd1, 0x99}},				{3, {0xe2, 0x80, 0xba}},
	{2, {0xd1, 0x9a}},				{2, {0xd1, 0x9c}},
	{2, {0xd1, 0x9b}},				{2, {0xd1, 0x9f}},

	{2, {0xc2, 0xa0}},				{2, {0xd0, 0x8e}},
	{2, {0xd1, 0x9e}},				{2, {0xd0, 0x88}},
	{2, {0xc2, 0xa4}},				{2, {0xd2, 0x90}},
	{2, {0xc2, 0xa6}},				{2, {0xc2, 0xa7}},
	{2, {0xd0, 0x81}},				{2, {0xc2, 0xa9}},
	{2, {0xd0, 0x84}},				{2, {0xc2, 0xab}},
	{2, {0xc2, 0xac}},				{2, {0xc2, 0xad}},
	{2, {0xc2, 0xae}},				{2, {0xd0, 0x87}},

	{2, {0xc2, 0xb0}},				{2, {0xc2, 0xb1}},
	{2, {0xd0, 0x86}},				{2, {0xd1, 0x96}},
	{2, {0xd2, 0x91}},				{2, {0xc2, 0xb5}},
	{2, {0xc2, 0xb6}},				{2, {0xc2, 0xb7}},
	{2, {0xd1, 0x91}},				{3, {0xe2, 0x84, 0x96}},
	{2, {0xd1, 0x94}},				{2, {0xc2, 0xbb}},
	{2, {0xd1, 0x98}},				{2, {0xd0, 0x85}},
	{2, {0xd1, 0x95}},				{2, {0xd1, 0x97}},

	{2, {0xd0, 0x90}},				{2, {0xd0, 0x91}},
	{2, {0xd0, 0x92}},				{2, {0xd0, 0x93}},
	{2, {0xd0, 0x94}},				{2, {0xd0, 0x95}},
	{2, {0xd0, 0x96}},				{2, {0xd0, 0x97}},
	{2, {0xd0, 0x98}},				{2, {0xd0, 0x99}},
	{2, {0xd0, 0x9a}},				{2, {0xd0, 0x9b}},
	{2, {0xd0, 0x9c}},				{2, {0xd0, 0x9d}},
	{2, {0xd0, 0x9e}},				{2, {0xd0, 0x9f}},

	{2, {0xd0, 0xa0}},				{2, {0xd0, 0xa1}},
	{2, {0xd0, 0xa2}},				{2, {0xd0, 0xa3}},
	{2, {0xd0, 0xa4}},				{2, {0xd0, 0xa5}},
	{2, {0xd0, 0xa6}},				{2, {0xd0, 0xa7}},
	{2, {0xd0, 0xa8}},				{2, {0xd0, 0xa9}},
	{2, {0xd0, 0xaa}},				{2, {0xd0, 0xab}},
	{2, {0xd0, 0xac}},				{2, {0xd0, 0xad}},
	{2, {0xd0, 0xae}},				{2, {0xd0, 0xaf}},

	{2, {0xd0, 0xb0}},				{2, {0xd0, 0xb1}},
	{2, {0xd0, 0xb2}},				{2, {0xd0, 0xb3}},
	{2, {0xd0, 0xb4}},				{2, {0xd0, 0xb5}},
	{2, {0xd0, 0xb6}},				{2, {0xd0, 0xb7}},
	{2, {0xd0, 0xb8}},				{2, {0xd0, 0xb9}},
	{2, {0xd0, 0xba}},				{2, {0xd0, 0xbb}},
	{2, {0xd0, 0xbc}},				{2, {0xd0, 0xbd}},
	{2, {0xd0, 0xbe}},				{2, {0xd0, 0xbf}},

	{2, {0xd1, 0x80}},				{2, {0xd1, 0x81}},
	{2, {0xd1, 0x82}},				{2, {0xd1, 0x83}},
	{2, {0xd1, 0x84}},				{2, {0xd1, 0x85}},
	{2, {0xd1, 0x86}},				{2, {0xd1, 0x87}},
	{2, {0xd1, 0x88}},				{2, {0xd1, 0x89}},
	{2, {0xd1, 0x8a}},				{2, {0xd1, 0x8b}},
	{2, {0xd1, 0x8c}},				{2, {0xd1, 0x8d}},
	{2, {0xd1, 0x8e}},				{2, {0xd1, 0x8f}}
};

static const uint32_t koi8_table[128] = {
	0x2500, 0x2502, 0x250c, 0x2510, 0x2514, 0x2518, 0x251c, 0x2524, 0x252c, 0x2534, 0x253c, 0x2580, 0x2584, 0x2588, 0x258c, 0x2590,
	0x2591, 0x2592, 0x2593, 0x2320, 0x25a0, 0x2219, 0x221a, 0x2248, 0x2264, 0x2265, 0xa0, 0x2321, 0xb0, 0xb2, 0xb7, 0xf7,
	0x2550, 0x2551, 0x2552, 0x451, 0x2553, 0x2554, 0x2555, 0x2556, 0x2557, 0x2558, 0x2559, 0x255a, 0x255b, 0x255c, 0x255d, 0x255e,
	0x255f, 0x2560, 0x2561, 0x401, 0x2562, 0x2563, 0x2564, 0x2565, 0x2566, 0x2567, 0x2568, 0x2569, 0x256a, 0x256b, 0x256c, 0xa9,
	0x44e, 0x430, 0x431, 0x446, 0x434, 0x435, 0x444, 0x433, 0x445, 0x438, 0x439, 0x43A, 0x43b, 0x43c, 0x43d, 0x43e,
	0x43f, 0x44f, 0x440, 0x441, 0x442, 0x443, 0x436, 0x432, 0x44c, 0x44B, 0x437, 0x448, 0x44d, 0x449, 0x447, 0x44A,
	0x42e, 0x410, 0x411, 0x426, 0x414, 0x415, 0x424, 0x413, 0x425, 0x418, 0x419, 0x41a, 0x41b, 0x41c, 0x41d, 0x41e,
	0x41f, 0x42f, 0x420, 0x421, 0x422, 0x423, 0x416, 0x412, 0x42c, 0x42b, 0x417, 0x428, 0x42d, 0x429, 0x427, 0x42a
};

static const uint32_t iso88595_table[128] = {
	0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87, 0x88, 0x89, 0x8A, 0x8B, 0x8C, 0x8D, 0x8E, 0x8F,
	0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97, 0x98, 0x99, 0x9A, 0x9B, 0x9C, 0x9D, 0x9E, 0x9F, 	 
	0xA0, 0x401, 0x402, 0x403, 0x404, 0x405, 0x406, 0x407, 0x408, 0x409, 0x40A, 0x40B, 0x40C, 0xAD, 0x40E, 0x40F,
	0x410, 0x411, 0x412, 0x413, 0x414, 0x415, 0x416, 0x417, 0x418, 0x419, 0x41A, 0x41B, 0x41C, 0x41D, 0x41E, 0x41F,
	0x420, 0x421, 0x422, 0x423, 0x424, 0x425, 0x426, 0x427, 0x428, 0x429, 0x42A, 0x42B, 0x42C, 0x42D, 0x42E, 0x42F,
	0x430, 0x431, 0x432, 0x433, 0x434, 0x435, 0x436, 0x437, 0x438, 0x439, 0x43A, 0x43B, 0x43C, 0x43D, 0x43E, 0x43F,
	0x440, 0x441, 0x442, 0x443, 0x444, 0x445, 0x446, 0x447, 0x448, 0x449, 0x44A, 0x44B, 0x44C, 0x44D, 0x44E, 0x44F,
	0x2116, 0x451, 0x452, 0x453, 0x454, 0x455, 0x456, 0x457, 0x458, 0x459, 0x45A, 0x45B, 0x45C, 0xA7, 0x45E, 0x45F
};



static uint8_t convertPoint(uint32_t t_point, uint8_t* t_buf)
{
	if (t_point <= 0x7f) {
		t_buf[0] = (uint8_t)(t_point);
		return 1;
	}
	else if (t_point <= 0x7ff) {
		t_buf[0] = (( (uint8_t)(t_point >> 6) ) | (11 << 6)) & ~(1 << 5);
		t_buf[1] = (((uint8_t)(t_point)) | (1 << 7)) & ~(1 << 6);
		return 2;
	}
	else if (t_point <= 0xffff) {
		t_buf[0] = (((uint8_t)(t_point >> 12)) | (111 << 5)) & ~(1 << 4);
		t_buf[1] = (((uint8_t)(t_point >> 6)) | (1 << 7)) & ~(1 << 6);
		t_buf[2] = (((uint8_t)(t_point)) | (1 << 7)) & ~(1 << 6);
		return 3;
	}
	else if (t_point <= 0x10ffff) {
		t_buf[0] = (((uint8_t)(t_point >> 18)) | (1111 << 4)) & ~(1 << 3);
		t_buf[1] = (((uint8_t)(t_point >> 12)) | (1 << 7)) & ~(1 << 6);
		t_buf[2] = (((uint8_t)(t_point >> 6)) | (1 << 7)) & ~(1 << 6);
		t_buf[3] = (((uint8_t)(t_point)) | (1 << 7)) & ~(1 << 6);
		return 4;
	}
	else {
		return 0;
	}
}


static int convertFromCP1251(FILE* t_src_file, FILE* t_dst_file)
{
	uint8_t src_buf[1024];
	uint8_t dst_buf[1024];
	uint16_t dst_count = 0;
	while (!feof(t_src_file)) {
		size_t count = fread(src_buf, sizeof(src_buf[0]), 1024, t_src_file);
		for (size_t i = 0; i < count; ++i) {
			uint8_t ch = src_buf[i];
			if (ch < 0x80) {
				dst_buf[dst_count] = ch;
				++dst_count;
			}
			else {
				memcpy(&dst_buf[dst_count],
					   cp1251_table[ch - 0x80].ch,
					   cp1251_table[ch - 0x80].bytes);
				dst_count += cp1251_table[ch - 0x80].bytes;
			}
			if (dst_count >= 1020) {
				fwrite(dst_buf, sizeof(dst_buf[0]), dst_count, t_dst_file);
				dst_count = 0;
			}
		}
	}

	if (dst_count) {
		fwrite(dst_buf, sizeof(dst_buf[0]), dst_count, t_dst_file);
	}

	return 1;
}

static int convert(FILE* t_src_file, FILE* t_dst_file, const uint32_t* t_code_table)
{
	uint8_t src_buf[1024];
	uint8_t dst_buf[1024];
	uint16_t dst_count = 0;
	while (!feof(t_src_file)) {
		size_t count = fread(src_buf, sizeof(src_buf[0]), 1024, t_src_file);
		for (size_t i = 0; i < count; ++i) {
			uint8_t ch = src_buf[i];
			if (ch < 0x80) {
				dst_buf[dst_count] = ch;
				++dst_count;
			}
			else {
				dst_count += convertPoint(t_code_table[ch - 0x80], &dst_buf[dst_count]);
			}
			if (dst_count >= 1020) {
				fwrite(dst_buf, sizeof(dst_buf[0]), dst_count, t_dst_file);
				dst_count = 0;
			}
		}
	}

	if (dst_count) {
		fwrite(dst_buf, sizeof(dst_buf[0]), dst_count, t_dst_file);
	}

	return 1;
}



int convertToUTF8(const char* t_src_file, Codec t_codec, const char* t_dst_file)
{
	FILE* src_f = fopen(t_src_file, "r+");
	if (src_f == NULL) {
		return 0;
	}
	FILE* dst_f = fopen(t_dst_file, "w");
	if (dst_f == NULL) {
		fclose(src_f);
		return 0;
	}

	int res = 0;
	switch (t_codec) {
		case CP1251:
			res = convertFromCP1251(src_f, dst_f);
			break;
		case KOI8:
			res = convert(src_f, dst_f, koi8_table);
			break;
		case ISO88595:
			res = convert(src_f, dst_f, iso88595_table);
			break;
		default:
			break;
	}

	fclose(src_f);
	fclose(dst_f);
	return res;
}
